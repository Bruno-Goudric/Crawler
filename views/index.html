<!doctype html>

<html>
    <head>
        <title>Crawler</title>
        <style>
            * {
                padding: 0px;
                margin:0px;
                box-sizing: border-box;
                font-family: cursive;
            }
            body{
                background: linear-gradient(340deg, #202c51, #1c3da2);
                display: flex;
                overflow: hidden;
                flex-wrap: wrap;
            }

            aside{
                width: 30vw;
                background-color: #fffffff0;
                border-radius: 0px 50px 50px 0px;
                padding: 20px;
                position: relative;
                left: 0px;
                transition: 1s;
                filter: drop-shadow(2px 4px 6px black);
            }

            .conteudo{
                overflow: auto;
                height: 100vh;
                width: 70vw;
                transition: 1s;
            }

            .divHr{
                display: flex;
                justify-content: center;
            }

            .hr20{
                width: 20%;
                margin-top: 5px;
                height: 3px;
                background-color: #fff;
                border: none;
            }

            .divHr100{
                display: flex;
                justify-content: center;
                padding:30px 100px 0px 100px;
            }

            .hr100{
                width: 100%;
                margin-top: 5px;
                height: 3px;
                background-color: #fff;
                border: none;
            }

            nav{
                height: 100px;
                background-color: #fff;
                border-radius: 0px 0px 100% 100%;
                box-shadow: 0px 0px 16px 10px #273358;
                margin-bottom: 25px;
            }

            h2{
                text-align: center;
                color: #fff;
                font-weight: 900;
            }

            .container{
                padding:0px 30px 30px 30px;
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }

            .item{
                min-height: 200px;
                width: 32%;
                background-color: #fff;
                border-radius: 15px;
                overflow: hidden;
                margin: 20px 5px;
                filter: drop-shadow(2px 5px 5px rgba(0,0,0,0.5));
                transition: .5s;
                z-index: -1;
            }

            .header{
                background-color: #25366a;
                height: 60px;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 24px;
                box-shadow: inset 10px 10px 10px 10px #25366a;
                color: #fff;
            }

            .content{
                padding: 20px;
            }

            ul{
                list-style: none;
            }

            li{
                background-color: #45589291;
                border-radius: 5px;
                padding: 5px 30px 5px 15px;
                margin: 10px 0px;
                position: relative;
            }

            .textWrap{
                word-break: break-all;
                text-overflow: ellipsis;
                overflow: hidden;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
            }

            .input{
                display: flex;
                justify-content: center;
                align-items: center;
                margin-top: 20px;
            }

            input{
                width: 115px;
                color: transparent;
            }

            label{
                word-break: break-all;
            }

            .btnCollpase {
                position: absolute;
                right: 3px;
                top: 1px;
                height: 100%;
                width: 25px;
                background-color: #0000;
                border: none;
                outline: none;
            }

            button > img{
                width: 14px;
                /*background-color: #fff;*/
                clip-path: circle(10px);
                cursor: pointer;
                transition: .5s;
                /*filter: drop-shadow(2px 4px 6px black);*/
            }

            .collapsed{
                height: auto;
                display: block;
            }

            .collapsedImg{
                transform: rotate(180deg);
            }

            .btnCrawler{
                margin: 0px 15px;
                display: block;
                background-color: #5db379;
                padding: 10px 20px;
                border: none;
                border-radius: 10px;
                color: #fff;
                font-weight: 700;
                font-size: 18px;
                border-bottom: 4px solid #4c8e62;
                cursor: pointer;
                outline: none;
            }

            .btnCrawler:not([disabled]):hover{
                background-color:#569e6e;
            }

            .btnCrawler:not([disabled]):hover:active{
                margin-top: 4px;
                border-bottom: 0px solid #569e6e;
            }

            .btnCrawler:disabled {
                cursor: unset;
                background-color: #909090;
                border-bottom: 4px solid #616161;
            }

            .btnCrawler:disabled:hover {
                border-bottom: 4px solid #616161;
            }

            .inputUrl{
                padding: 15px;
                text-align: center;
                display: flex;
                justify-content: center;
                align-items: flex-end;
            }

            .inputUrl > label{
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                position: relative;
            }
            .inputUrl > label > div{
                position: relative;
            }

            input {
                color: #000;
                padding: 5px 20px;
                width: 22vw;
                height: 40px;
                border-radius: 100px;
                border: none;
                outline: none;
                box-shadow: 2px 1px 6px -3px rgba(0,0,0,0.7);
            }

            .hintUrl{
                position: absolute;
                background-color: #de7c7c;
                padding: 5px 20px;
                border-radius: 7px;
                height: 32px;
                top: -42px;
                right: 0px;
                display: none;
                opacity: 0;
                transition: .3s;
                white-space: nowrap;
            }

            .hintUrl::after{
                content: '';
                position: absolute;
                width: 0;
                height: 0;
                border-left: 10px solid #0000;
                border-right: 10px solid #0000;
                border-top: 10px solid #de7c7c;
                bottom: -8px;
                left: 15px;
            }

            .filtros{
                text-align: center;
                padding: 20px;
            }

            .btnFiltrar {
                background-color: #dad56b;
                border: none;
                border-radius: 10px;
                padding: 10px 20px;
                border-bottom: 4px solid #9a9644;
                outline: none;
                cursor: pointer;
                height: 40px;
            }

            .btnFiltrar:hover{
                background-color: #afaa52;
            }

            .btnInstancias {
                padding: 10px;
                border: none;
                border-radius: 15px 15px 0px 0px;
                font-size: 16px;
                outline: none !important;
                cursor: pointer;
            }

            .btnInstancias:hover{
                background-color: #d2d3d7;
            }

            .cardStatusCrawler{
                position: relative;
                background-color: #83d69a;
                border-radius: 15px;
                padding: 20px;
                border: 2px solid #fff;
                box-shadow: 0px 0px 10px 2px #000;
                margin-top: 25px;
                margin-right: 15px;
                margin-left: 15px;
            }

            .cardsStatus {
                display: flex;
                position: absolute;
                top: calc(100vh - 42px);
                right: 20px;
                flex-direction: column;
                background-color: #ffffff80;
                border-radius: 15px 15px 0px 0px;
                height: 100vh;
                transition: 1s;
                min-width: 291px;
            }

            #cardsStatus{
                overflow: auto;
                height: calc(100vh - 93px);
                padding-bottom: 30px;
            }

            .acao{
                flex-direction: column;
                display: flex;
            }

            .acao > button{
                background-color: #0000;
                border: 2px solid #f00;
                border-radius: 100px;
                width: 30px;
                height: 30px;
                font-size: 14px;
                color: #f00;
                cursor: pointer;
                outline: none;
                margin-top: 10px;
            }

            .time{
                margin-right: 20px;
            }

            .funcoes{
                padding-top: 10px;
            }
            
            .funcoes > i {
                margin-right: 10px;
            }

            .funcoes > i:hover {
                color: #3552ad;
            }

            .idInstancia {
                position: absolute;
                right: 10px;
                top: 5px;
            }

            .disabled{
                display: none;
            }

            .filtros{
                display: flex;
                justify-content: center;
                align-items: flex-end;
            }

            .filtros > div{
                display: flex;
                flex-direction: column;
                margin: 0px 10px;
                align-items: flex-start;
                color: #fff;
            }

            select{
                height: 40px;
                border-radius: 10px;
                outline: none;
            }

            .protocolo{
                margin-right: 25px;
            }

            #numCrawlers::-webkit-outer-spin-button,
            #numCrawlers::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            fieldset{
                padding: 20px;
                border-radius: 10px;
                margin-bottom: 15px;
            }

            legend{
                width: 35%;
                text-align: center;
            }

            .modalLinks{
                display: none;
                justify-content: center;
                align-items: center;
                position: absolute;
                background-color: #0009;
                width: 100%;
                height: 100%;
            }

            .modalLinksBody{
                background-color: #fff;
                border-radius: 20px;
                width: 50vw;
                height: 70vh;
                overflow: hidden;
                position: relative;
            }

            #modalLinksBody{
                overflow: auto;
                height: calc(70vh - 100px);
                padding: 30px;
            }

            .modalErros{
                display: none;
                justify-content: center;
                align-items: center;
                position: absolute;
                background-color: #0009;
                width: 100%;
                height: 100%;
            }

            .modalErrosBody{
                background-color: #fff;
                border-radius: 20px;
                width: 50vw;
                height: 70vh;
                overflow: hidden;
                position: relative;
            }

            #modalErrosBody{
                display: flex;
                flex-wrap: wrap;
                overflow: auto;
                height: calc(70vh - 100px);
                padding: 30px;
            }

            .modalConfiguracao{
                display: none;
                justify-content: center;
                align-items: center;
                position: absolute;
                background-color: #0009;
                width: 100%;
                height: 100%;
            }

            .modalConfiguracaoBody{
                background-color: #fff;
                border-radius: 20px;
                width: 50vw;
                height: auto;
                overflow: hidden;
                position: relative;
            }
            
            #modalConfiguracaoBody{
                overflow: auto;
                padding: 30px;
            }

            #modalConfiguracaoBody > fieldset{
                width: 100%;
                height: max-content;
            }

            #modalErrosBody > .item{
                min-height: 200px;
                width: 31%;
                background-color: #fff;
                border-radius: 15px;
                overflow: hidden;
                margin: 20px 5px;
                filter: drop-shadow(2px 5px 5px rgba(0,0,0,0.5));
                transition: .5s;
            }

            .buttonsModal{
                padding: 5px 25px;
                text-align: end;
                margin-bottom: 10px;
            }

            .buttonsModal > .btnFecharModal {
                position: relative;
                background-color: #616161;
                padding: 5px 25px;
                border-radius: 10px;
                border: none;
                border-bottom: 5px solid #000;
                color: #fff;
                font-weight: bolder;
                font-size: 16px;
                cursor: pointer;
                outline: none !important;
                right: initial;
                bottom: initial;
            }

            .buttonsModal > .btnEnviarConfiguracao {
                position: relative;
                background-color: #5db379;
                padding: 5px 25px;
                border-radius: 10px;
                border: none;
                border-bottom: 5px solid #427e56;
                color: #fff;
                font-weight: bolder;
                font-size: 16px;
                cursor: pointer;
                outline: none !important;
                right: initial;
                bottom: initial;
            }

            .btnEnviarConfiguracao:hover{
                background-color: #529f6b;
            }

            .btnEnviarConfiguracao:hover:active{
                background-color: #458a5c;
                border:none;
            }

            .btnFecharModal {
                position: absolute;
                right: 20px;
                bottom: 15px;
                background-color: #616161;
                padding: 5px 25px;
                border-radius: 10px;
                border: none;
                border-bottom: 5px solid #000;
                color: #fff;
                font-weight: bolder;
                font-size: 16px;
                cursor: pointer;
                outline: none !important;
            }

            .btnFecharModal:hover {
                background-color: #484848;
            }

            .btnFecharModal:hover:active {
                background-color: #484848;
                border: none;
            }

            .fa-eye{
                color: #4c8e62;
                cursor: pointer;
            }

            .fa-eye:hover{
                color: #3f6a03;
            }

            #modalLinksBody > ul > li {
                word-break: break-all;
            }

            .btnControleCrawler{
                position: absolute;
                right: -114px;
                top: 115px;
                padding: 10px 20px;
                transform: rotate(90deg);
                border: none;
                background-color: #f0f0f1;
                border-radius: 15px 15px 0px 0px;
                font-size: 16px;
                outline: none !important;
                cursor: pointer;
                z-index: 999;
            }

            .btnControleCrawler:hover{
                background-color: #d2d3d7;
            }

            .asideHidden{
                left: -500px;
            }
        </style>
        <script src="https://kit.fontawesome.com/f38600d786.js" crossorigin="anonymous"></script>
    </head>
    <body>
        <aside>
            <button class="btnControleCrawler">Controle do Crawler</button>
            
            <div class="inputUrl">
                
                <label>
                    <div>
                        URL base:
                        <div>
                            <div class="hintUrl">hint</div>
                            <input type="text" id="urlBase"></input>
                        </div>
                    </div>
                </label>
                
            </div>
            <label style="margin: 10px 0px;display: flex;flex-direction: column;justify-content: center;align-items: center;">
                Palavras chaves (Separe por ';'):
                <div>
                    <div class="hintUrl">hint</div>
                    <input type="text" id="palavrasChaves"></input>
                </div>
            </label>

            <label style="margin: 10px 0px;display: flex;flex-direction: column;justify-content: center;align-items: center;">
                Exceções (Separe por ';'):
                <div>
                    <input type="text" id="palavrasExcecao"></input>
                </div>
            </label>
            <div style="display: flex;justify-content: center;align-items: center;padding: 10px;">
                <label>
                    Iniciar <input type="number" maxlength="15" max="15" id="numCrawlers" style="width: 60px;text-align: center;" value="1"> Crawler simultaneo
                </label>
            </div>
            <div style="display: flex;justify-content: center;align-items: center;padding: 10px;">
                <label>
                    <input type="checkbox" id="repetirUrl" style="height: 18px;width: 18px;"> Não repetir urls do Crawler anterior
                </label>
            </div>

            <fieldset>
                <legend>Funções</legend>
                <label>
                    <input type="checkbox" id="ConsoleErros" style="height: 18px;width: 18px;"> Console errors
                </label>
                <br/>
                <label>
                    <input type="checkbox" id="Printscreen" style="height: 18px;width: 18px;"> Printscreen
                </label>
                <br/>
                <label>
                    <input type="checkbox" id="ObterLinks" style="height: 18px;width: 18px;"> Obter links
                </label> <i class="fas fa-eye" onclick="abreLog()"></i>
                <br/>
                <label>
                    <input type="checkbox" id="ObterLinksRepetidos" style="height: 18px;width: 18px;"> Obter links repetidos
                </label>
            </fieldset>

            <div style="display: flex;justify-content: center;align-items: center;">
                <button onclick="startCrawler(1)" class="btnCrawler">Iniciar Crawler</button>
            </div>
            <div style="text-align: center;margin-top: 10px;">
                <label>
                    <input type="checkbox" id="mostrarBrowser" style="height: 18px;width: 18px;"> Mostrar browser
                </label>
            </div>
            <br/>
            
        </aside>
        
        <div class="conteudo">
            <h2 id="qtd">
            </h2>
            <div class="filtros">
                <div>
                    Status:
                    <select id="status">
                        <option default>Selecione</option>
                        <option>Todos</option>
                        <option>Console</option>
                        <option>Request</option>
                        <option>Response</option>
                        <option>Page error</option>
                    </select>
                </div>
                <div>
                    Dominio:
                    <select id="dominios">
                        <option default>Selecione</option>
                        <option>Todos</option>
                    </select>
                </div>
                <button class="btnFiltrar" id="btnFiltrar"><i class="fas fa-search"></i> Filtrar</button>
            </div>
            <div class="container" id="itemList">
            </div>
        </div>
        
        <div class="cardsStatus">
            <button class="btnInstancias">Instancias</button>
            <div id="cardsStatus">

            </div>      
        </div>

        <div class="modalLinks">
            <div class="modalLinksBody">
                <h3 style="text-align: center;margin-bottom: 10px;">Todos os links acessados</h3>
                <div id="modalLinksBody">

                </div>                
                <button class="btnFecharModal" id="btnFecharModal">Fechar</button>
            </div>
        </div>

        <div class="modalErros">
            <div class="modalErrosBody">
                <h3 style="text-align: center;margin-bottom: 10px;">Erros encontrados</h3>
                <div id="modalErrosBody">

                </div>                
                <button class="btnFecharModal" id="btnFecharModalErros">Fechar</button>
            </div>
        </div>

        <div class="modalConfiguracao">
            <div class="modalConfiguracaoBody">
                <h3 style="text-align: center;margin-bottom: 10px;">Configuração</h3>
                <div id="modalConfiguracaoBody">
                    <fieldset>
                        <legend>Funções</legend>
                        <label>
                            <input type="checkbox" id="ConsoleErrosConfiguracao" style="height: 18px;width: 18px;"> Console errors
                        </label>
                        <br/>
                        <label>
                            <input type="checkbox" id="PrintscreenConfiguracao" style="height: 18px;width: 18px;"> Printscreen
                        </label>
                        <br/>
                        <label>
                            <input type="checkbox" id="ObterLinksConfiguracao" style="height: 18px;width: 18px;"> Obter links
                        </label> <i class="fas fa-eye" onclick="abreLog()"></i>
                        <br/>
                        <label>
                            <input type="checkbox" id="ObterLinksRepetidosConfiguracao" style="height: 18px;width: 18px;"> Obter links repetidos
                        </label>
                    </fieldset>
                    Usar urls obtidas da instancia: &nbsp;&nbsp;
                    <select id="urlsInstancia" style="margin-top: -5px;">
                        <option default>Selecione</option>
                    </select>
                </div>             
                <div class="buttonsModal">
                    <button class="btnEnviarConfiguracao" id="btnEnviarConfiguracao">Enviar</button>
                    <button class="btnFecharModal" id="btnFecharModalConfiguracao">Fechar</button>
                </div>
            </div>
        </div>

        <script src="https://kit.fontawesome.com/f38600d786.js" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js", integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=", crossorigin="anonymous")></script>
        <script> 
            (()=>{
                getLog();
                verificaCrawler(false);
            })();

            let arrErroMontado = [];
            let selectDominio = [];
            let flagCount = true;

            $("#btnFiltrar").on("click",function(){                
                filtrarPorDominio();                
                filtrarPorStatus();
            });

            $("#dominios").on("change",function(){
                filtrarPorDominio();
                filtrarPorStatus();
            });

            $("#status").on("change",function(){
                filtrarPorDominio();
                filtrarPorStatus();
            });

            $("#btnFecharModalErros").on("click", function(){
                $(".modalErros").eq(0).fadeOut();
            });

            $("#btnFecharModal").on("click", function(){
                $(".modalLinks").eq(0).fadeOut();
            });

            $("#btnFecharModalConfiguracao").on("click", function(){
                $(".modalConfiguracao").eq(0).fadeOut();
            });

            $(".btnControleCrawler").eq(0).on("click",function(){
                let $aside = $("aside");
                let $conteudo = $(".conteudo").eq(0);
                if($aside.css("left") == "0px"){
                    $aside.css("left","-30vw");
                    $conteudo.css("width","100vw");
                    $conteudo.css("margin-left","-30vw");
                }else{
                    $aside.css("left","0px");
                    $conteudo.css("width","70vw");
                    $conteudo.css("margin-left","0px");
                }
            });

            $(".btnInstancias").eq(0).on("click",function(){
                let $conteudo = $(".cardsStatus").eq(0);
                if($conteudo.css("top") == "50px"){
                    $conteudo.css("top","calc(100vh - 42px)");
                }else{
                    $conteudo.css("top","50px");
                }
            });

            let IdEnviar;
            let quantidadeInstancia;
            let instancias;

            $("#btnEnviarConfiguracao").on("click",function(){
                let consoleError = $("#ConsoleErrosConfiguracao").prop("checked");
                let printscreen = $("#PrintscreenConfiguracao").prop("checked");
                let obterLinks = $("#ObterLinksConfiguracao").prop("checked");
                let obterLinksRepetidos = $("#ObterLinksRepetidosConfiguracao").prop("checked");
                let instancia = $("#urlsInstancia").val();
                enviarConfiguracao(IdEnviar, consoleError, printscreen, obterLinks, obterLinksRepetidos, instancia);
            });

            function abreLog(){
                getLinks();
                $(".modalLinks").eq(0).css("display","flex");
            }

            function filtrarPorDominio(){
                let dominio = $("#dominios").val();
                if(dominio != "Selecione" && dominio != "Todos"){
                    let c = 0;
                    $(".item").map(e=>{
                        if($(".item").eq(e).children().eq(0)[0].innerText.replace(/ +/g,"").replace(/\r?\n|\r/g,"") == dominio){
                            $(".item").eq(e).removeClass("disabled");
                            c++;
                        }else{ 
                            $(".item").eq(e).addClass("disabled");
                        }
                    });
                    
                    $("#qtd").html(c + " ocorrências");
                }else if(dominio == "Todos"){
                    let c = 0;
                    $(".item").map(e=>{
                        c++;
                        $(".item").eq(e).removeClass("disabled");
                    });
                    $("#qtd").html(c + " ocorrências");
                }
            }

            function filtrarPorStatus(){
                
                let status = $("#status").val();
                if(status == "Selecione"){
                    $(".console").removeClass("disabled");
                    $(".request").removeClass("disabled");
                    $(".response").removeClass("disabled");
                    $(".pageError").removeClass("disabled");
                }else{
                    let cons = true;
                    let req = true;
                    let resp = true;
                    let pag = true;
                    
                    switch(status.toLowerCase().replace(/ /g,"")){
                        case "console":
                            cons = false;
                            req = true;
                            resp = true;
                            pag = true;
                            escondeItem("console");
                            break; 
                        case "request":
                            cons = true;
                            req = false;
                            resp = true;
                            pag = true;
                            escondeItem("request");
                            break; 
                        case "response":
                            cons = true;
                            req = true;
                            resp = false;
                            pag = true;
                            escondeItem("response");
                            break; 
                        case "pageerror":
                            cons = true;
                            req = true;
                            resp = true;
                            pag = false;
                            escondeItem("pageerror");
                            break;
                        case "todos":
                            cons = false;
                            req = false;
                            resp = false;
                            pag = false;
                            escondeItem("todos");
                            break; 
                    }

                    cons ? $(".console").addClass("disabled") : $(".console").removeClass("disabled");
                    req ? $(".request").addClass("disabled") : $(".request").removeClass("disabled");
                    resp ? $(".response").addClass("disabled") : $(".response").removeClass("disabled");
                    pag ? $(".pageError").addClass("disabled") : $(".pageError").removeClass("disabled");
                }
            }
            
            function escondeItem(status){
                let ocorrencias = 0;

                $(".item").map(e=>{
                    let item = $(".item").eq(e).children().eq(1).children().eq(2).children();
                    count = 0;

                    for(let i=0; i<item.length;i++){
                        let className= item[i].className;
                        switch(status){
                            case "console":
                                if(!(className.search("request") >=0 || className.search("response") >=0 || className.search("pageError") >=0)){
                                    item.removeClass("disabled");

                                    count++;
                                }
                            break; 
                        case "request":
                                if(!(className.search("console") >=0 || className.search("response") >=0 || className.search("pageError") >=0)){
                                    item.removeClass("disabled");

                                    count++;
                                }
                            break; 
                        case "response":
                                if(!(className.search("console") >=0 || className.search("request") >=0 || className.search("pageError") >=0)){
                                    item.removeClass("disabled");
                                    count++;
                                }

                            break; 
                        case "pageerror":
                                if(!(className.search("console") >=0 || className.search("request") >=0 || className.search("response") >=0)){
                                    item.removeClass("disabled");
                                    count++;
                                }

                            break;
                        case "todos":

                            count++;

                            break;
                        }
                        
                    }
                    if(count>0){
                            item.parent().parent().parent().eq(0).removeClass("disabled");
                            ocorrencias++;
                    }else{
                        item.parent().parent().parent().eq(0).addClass("disabled");
                    }
                });

                $("#qtd").html(ocorrencias + " ocorrências");
            }

            function montaTela(data){
                let count = 0;
                data.forEach((e,i)=>{
                    
                    let li = "";
                    if(data[i].erros != undefined && data[i].erros != ""){
                        if(!arrErroMontado.includes(e.protocolo+"://"+e.dominio+e.pagina)){
                            arrErroMontado.push(e.protocolo+"://"+e.dominio+e.pagina);
                            if(!selectDominio.includes(e.dominio)){
                                selectDominio.push(e.dominio);
                                $("#dominios").append("<option value='" + e.dominio + "'>" + e.dominio + "</option>");
                            }
                            count++;
                            for(let j =0; j<data[i].erros.length ; j++){
                                let button = data[i].erros[j].length >= 77 ? "<button class='btnCollpase'><img src='https://www.pngpix.com/wp-content/uploads/2016/10/PNGPIX-COM-Arrow-Down-PNG-Transparent-Image.png' id='imgErr"+i+""+j+"' onclick='collapse(\"Err"+i+""+j+"\")'/></button>" : "";
                                                            
                                if(data[i].erros[j].includes("PAGEERROR:")){
                                    let cor = "#bf6f6f";
                                    li = li + "<li id='lblErr"+i+""+j+"' class='textWrap pageError' style='background-color:"+cor+"'><label>" + data[i].erros[j].replace("|PAGEERROR", "PAGEERROR") +"</label>"+button+"</li>";
                            
                                }else if(data[i].erros[j].includes("REQUEST:")){
                                    let cor = "#6cb4ba";
                                    li = li + "<li id='lblErr"+i+""+j+"' class='textWrap request' style='background-color:"+cor+"'><label>" + data[i].erros[j].replace("|REQUEST", "REQUEST") +"</label>"+button+"</li>";
                            
                                }else if(data[i].erros[j].includes("CONSOLE")){
                                    let cor = "#d3d683";
                                    li = li + "<li id='lblErr"+i+""+j+"' class='textWrap console' style='background-color:"+cor+"'><label>" + data[i].erros[j].replace("|CONSOLE", "CONSOLE") +"</label>"+button+"</li>";
                            
                                }else if(data[i].erros[j].includes("RESPONSE")){
                                    let cor = "#d6b783";
                                    li = li + "<li id='lblErr"+i+""+j+"' class='textWrap response' style='background-color:"+cor+"'><label>" + data[i].erros[j].replace("|RESPONSE", "RESPONSE") +"</label>"+button+"</li>";
                                }else{
                                    let cor = "#83d69a";
                                    li = li + "<li id='lblErr"+i+""+j+"' class='textWrap generic' style='background-color:"+cor+"'><label>" + data[i].erros[j] +"</label>"+button+"</li>";
                                }
                            }
                            if(e.dominio == $("#dominios").val() || $("#dominios").val() == "Selecione" || $("#dominios").val() == "Todos"){
                                
                                $("#itemList").append(`
                                    <div class="item">
                                        <div class="header">
                                            ` + e.dominio + `
                                        </div>
                                        <div class="content">
                                            <p class="textWrap"><strong>Pagina:</strong> <label>` + e.pagina + `</label></p>
                                            <p class="textWrap"><strong>Url:</strong> <label><a href="` + e.protocolo+"://"+e.dominio+e.pagina + `">` + e.protocolo+"://"+e.dominio+e.pagina + `</a></label></p>
                                            <ul>
                                                ` + li + `
                                            </ul>
                                        </div>
                                    </div>
                                `);
                                $("#btnFiltrar").trigger("click");
                            }else{
                                $("#itemList").append(`
                                    <div class="item disabled">
                                        <div class="header">
                                            ` + e.dominio + `
                                        </div>
                                        <div class="content">
                                            <p class="textWrap"><strong>Pagina:</strong> <label>` + e.pagina + `</label></p>
                                            <p class="textWrap"><strong>Url:</strong> <label><a href="` + e.protocolo+"://"+e.dominio+e.pagina + `">` + e.protocolo+"://"+e.dominio+e.pagina + `</a></label></p>
                                            <ul>
                                                ` + li + `
                                            </ul>
                                        </div>
                                    </div>
                                `);
                            }
                            
                        }
                    }
                    if(($("#dominios").val() == "Selecione" || $("#dominios").val() == "Todos") && ($("#status").val() == "Selecione" || $("#status").val() == "Todos") ){
                        $("#qtd").html(arrErroMontado.length + " ocorrências");
                    }
                });                
            };

            function montaModalErro(data){
                let count = 0;
                data.forEach((e,i)=>{
                    
                    let li = "";
                    if(data[i].erros != undefined && data[i].erros != ""){
                        count++;
                        for(let j =0; j<data[i].erros.length ; j++){
                            let button = data[i].erros[j].length >= 77 ? "<button class='btnCollpase'><img src='https://www.pngpix.com/wp-content/uploads/2016/10/PNGPIX-COM-Arrow-Down-PNG-Transparent-Image.png' id='imgErr"+i+""+j+"' onclick='collapse(\"Err"+i+""+j+"\")'/></button>" : "";
                                                        
                            if(data[i].erros[j].includes("PAGEERROR:")){
                                let cor = "#bf6f6f";
                                li = li + "<li id='lblErr"+i+""+j+"' class='textWrap pageError' style='background-color:"+cor+"'><label>" + data[i].erros[j].replace("|PAGEERROR", "PAGEERROR") +"</label>"+button+"</li>";
                        
                            }else if(data[i].erros[j].includes("REQUEST:")){
                                let cor = "#6cb4ba";
                                li = li + "<li id='lblErr"+i+""+j+"' class='textWrap request' style='background-color:"+cor+"'><label>" + data[i].erros[j].replace("|REQUEST", "REQUEST") +"</label>"+button+"</li>";
                        
                            }else if(data[i].erros[j].includes("CONSOLE")){
                                let cor = "#d3d683";
                                li = li + "<li id='lblErr"+i+""+j+"' class='textWrap console' style='background-color:"+cor+"'><label>" + data[i].erros[j].replace("|CONSOLE", "CONSOLE") +"</label>"+button+"</li>";
                        
                            }else if(data[i].erros[j].includes("RESPONSE")){
                                let cor = "#d6b783";
                                li = li + "<li id='lblErr"+i+""+j+"' class='textWrap response' style='background-color:"+cor+"'><label>" + data[i].erros[j].replace("|RESPONSE", "RESPONSE") +"</label>"+button+"</li>";
                            }else{
                                let cor = "#83d69a";
                                li = li + "<li id='lblErr"+i+""+j+"' class='textWrap generic' style='background-color:"+cor+"'><label>" + data[i].erros[j] +"</label>"+button+"</li>";
                            }
                        }
                            
                        $("#modalErrosBody").append(`
                            <div class="item">
                                <div class="header">
                                    ` + e.dominio + `
                                </div>
                                <div class="content">
                                    <p class="textWrap"><strong>Pagina:</strong> <label>` + e.pagina + `</label></p>
                                    <p class="textWrap"><strong>Url:</strong> <label><a href="` + e.protocolo+"://"+e.dominio+e.pagina + `">` + e.protocolo+"://"+e.dominio+e.pagina + `</a></label></p>
                                    <ul>
                                        ` + li + `
                                    </ul>
                                </div>
                            </div>
                        `);
                         
                    }
                });                
            };

            function collapse(id){
                if($("#lbl"+id+"").hasClass("collapsed")){
                    $("#lbl"+id+"").removeClass("collapsed");
                    $("#img"+id+"").removeClass("collapsedImg");
                }else{
                    $("#lbl"+id+"").addClass("collapsed");
                    $("#img"+id+"").addClass("collapsedImg");
                }
            }

            function startCrawler(){
                let mostrarBrowser = $("#mostrarBrowser:checked").val() == "on";
                let urlBase = $("#urlBase").val();
                let palavrasChave = $("#palavrasChaves").val();
                //let protocolo = $("#protocolo").val();
                let repetirUrl = $("#repetirUrl:checked").val() == "on";
                let numCrawlers = $("#numCrawlers").val();
                let excecoes = $("#palavrasExcecao").val();

                //Funções
                let consoleError = $("#ConsoleErros:checked").val() == "on";
                let printscreen = $("#Printscreen:checked").val() == "on";
                let obterLinks = $("#ObterLinks:checked").val() == "on";
                let obterLinksRepetidos = $("#ObterLinksRepetidos:checked").val() == "on";

                if(!urlBase.includes("http") || !urlBase.includes("://")){
                    urlBase = "https://" + urlBase;
                }
                
                if($("#urlBase").val() != null && $("#urlBase").val().length >= 6){
                    $.ajax({ 
                        type: 'POST', 
                        url: '/startCrawler', 
                        data: { MostrarBrowser: mostrarBrowser,baseUrl: urlBase,palavrasChave: palavrasChave, repetirUrl: repetirUrl, simultaneos: numCrawlers,excecoes: excecoes, ConsoleError: consoleError, Printscreen: printscreen, ObterLinks: obterLinks,ObterLinksRepetidos: obterLinksRepetidos}, 
                        success: function (data) {

                            verificaCrawler(true);
                            
                            setTimeout(()=>{
                                let $conteudo = $(".cardsStatus").eq(0);
                                if($conteudo.css("top") != "50px"){
                                    $conteudo.css("top","50px");
                                }
                            },2000);

                            setTimeout(()=>{
                                getLog();
                            },10000);
                            
                            
                        },
                        error: function(data){
                            console.log("Error: ",data);
                        }
                    });
                }else{
                    
                    $(".hintUrl").eq(0).html("Informe uma URL com pelo menos 6 caracteres!");                    
                    $(".hintUrl").eq(0).css("right","-" + (parseInt($(".hintUrl").eq(0).css("width").replace("px","")) - 50) + "px");
                    $(".hintUrl").eq(0).css("display","block");
                    setTimeout(()=>{
                        $(".hintUrl").eq(0).css("opacity","1");
                    },100);
                    setTimeout(()=>{
                        $(".hintUrl").eq(0).css("opacity","0");
                        setTimeout(()=>{
                            $(".hintUrl").eq(0).css("display","none");
                            $(".hintUrl").eq(0).css("right","0");
                        },200);
                    },4000);
                }
                
            }

            let myStatusPrimeiraInstancia;
            let myStatusSegundaInstancia;

            function verificaCrawler(bool){
                let tempo = 0;
                if(bool){
                    tempo = 1000;
                }

                setTimeout(()=>{
                    $.get("/statusCrawler", function(data){
                        if(data.length > 0){
                            quantidadeInstancia = data.length;
                            instancias = data;
                            $("#cardsStatus").html("");
                            data.map(e=>{
                                let consoleError = e.Funcoes.ConsoleError == "true" ? "<i class='fas fa-bug' onclick='getConsoleError(\"" + e.Timestamp + "\")' style='cursor: pointer;'></i>" : "";
                                let printscreen = e.Funcoes.Printscreen == "true" ? "<i class='fas fa-print'></i>" : "";
                                let obterLinks = e.Funcoes.ObterLinks == "true" ? "<i class='fas fa-link' onclick='getLinksInstancia(\"" + e.Timestamp + "\")' style='cursor: pointer;'></i>" : "";
                                let obterLinksRepetidos = e.Funcoes.ObterLinksRepetidos == "true" ? "<i class='fas fa-redo-alt'></i>" : "";
                                let configuracao = "<i class='fas fa-cog' onclick='configuracaoInstancia(\"" + e.Id + "\"," + e.Funcoes.ConsoleError + "," + e.Funcoes.Printscreen + "," + e.Funcoes.ObterLinks + "," + e.Funcoes.ObterLinksRepetidos + ")' style='cursor: pointer;'></i>";

                                $("#cardsStatus").append(`
                                <div class="cardStatusCrawler" id="status` + e.Id + `">
                                    <label class='idInstancia'>` + e.Id + `</label>
                                    <div style="display: flex;">
                                        <div>
                                            <div class="pagina">
                                                ` + e.Pagina + `
                                            </div>
                                            <div class="statusHeader">
                                                Status: <label id="rodando` + e.Id + `"></label>
                                            </div>
                                            
                                            <div class="time">
                                                <div>
                                                    Tempo de execução:
                                                </div>
                                                <div id="tempo` + e.Id + `">
                                                </div>
                                            </div>
                                            <div class="funcoes">
                                                `
                                                +
                                                    consoleError + printscreen + obterLinks + obterLinksRepetidos + configuracao
                                                +
                                                `
                                            </div>
                                        </div>
                                        <div style="display: flex;justify-content: center;align-items: center;">
                                            <div class="acao">
                                                <button onclick="deletarCrawler(` + e.Id + `)"><i class="fas fa-trash"></i></button>
                                                <button onclick="stopCrawler(` + e.Id + `)"><i class="fas fa-stop"></i></button>
                                                <button id='pausar` + e.Id + `' onclick="pausarCrawler(` + e.Id + `)"><i class="fas fa-pause"></i></button>
                                                <button id='continuar` + e.Id + `' onclick="continuarCrawler(` + e.Id + `)" style='display:none;'><i class="fas fa-play"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                `);
                            });

                            myStatusPrimeiraInstancia = setInterval(() => {
                                $.get("/statusCrawler", function(data){
                                    statusCrawler(data);
                                    $(".btnInstancias").eq(0).html("Instancias - " + data.length);
                                });
                            }, 1000);
                        }
                    });
                },tempo);
                
            }

            function statusCrawler(data){
                data.map((e)=>{
                    let timeGeral = e.Tempo;
                    let min = 0; 
                    let hora = 0;
                    min = parseInt(timeGeral/60);
                    let sec = timeGeral%60;
                    if(min >= 60){
                        hora = parseInt(min/60);
                        min = min%60;
                    }
                    sec = sec <10 ? "0"+sec:sec;
                    min = min <10 ? "0"+min:min;
                    hora = hora <10 ? "0"+hora:hora;
                    let montaTempo = hora + ":" + min + ":" + sec;
                    $("#tempo" + e.Id).html(montaTempo);
                    $("#rodando" + e.Id).html(e.Rodando ? "Rodando" : "Parado");
                    $("#rodando" + e.Id).html(e.Pausado ? "Pausado" : e.Rodando ? "Rodando" : "Parado");
                    
                    e.Rodando ? e.Pausado ? $("#status" + e.Id).css("background-color","#dfde80") : $("#status" + e.Id).css("background-color","#83d69a") : $("#status" + e.Id).css("background-color","#e68b8b");
                });

            }
            
            let dt;
            function getLog(){
                $.get("/getLog", function(data){
                    montaTela(data);
                });

                $.get("/statusCrawler", function(data){
                    if(data.some(e=>e.Rodando)){
                        setInterval(() => {
                            $.get("/getLog", function(data){
                                montaTela(data);
                            });
                        }, 10000);
                    }
                });  
            }

            function getLinks(){
                $.get("/getLinks", function(data){
                    let lista = "";
                    data.forEach(e=>lista+= "<li>" + e.Url + "</li>")
                    $("#modalLinksBody").html("<ul>" + lista + "</ul>");
                });
            }
            
            function stopCrawler(instancia){
                $.ajax({ 
                        type: 'POST', 
                        url: '/stopCrawler', 
                        data: { instancia: instancia}, 
                        success: function (data) {
                            
                        },
                        error: function(data){
                            console.log("Error: ",data);
                        }
                    });
            }

            function deletarCrawler(instancia){
                $.ajax({ 
                        type: 'POST', 
                        url: '/deleteCrawler', 
                        data: { instancia: instancia}, 
                        success: function (data) {
                            $("#status" + instancia).remove();                
                        },
                        error: function(data){
                            console.log("Error: ",data);
                        }
                    });
            }

            function pausarCrawler(instancia){
                $("#pausar"+instancia).css("display","none");
                $("#continuar"+instancia).css("display","block");

                $.ajax({ 
                        type: 'POST', 
                        url: '/pausarCrawler', 
                        data: { instancia: instancia}, 
                        success: function (data) {
                            
                        },
                        error: function(data){
                            console.log("Error: ",data);
                        }
                    });
            }

            function continuarCrawler(instancia){
                $("#pausar"+instancia).css("display","block");
                $("#continuar"+instancia).css("display","none");

                $.ajax({ 
                        type: 'POST', 
                        url: '/continuarCrawler', 
                        data: { instancia: instancia}, 
                        success: function (data) {
                            
                        },
                        error: function(data){
                            console.log("Error: ",data);
                        }
                    });
            }
        
            function getConsoleError(instancia){
                $.ajax({ 
                        type: 'POST', 
                        url: '/getConsoleError', 
                        data: { InstanciaResponsavel: instancia}, 
                        success: function (data) {
                            console.log(data);    
                            $(".modalErros").eq(0).css("display","flex");
                            montaModalErro(data);
                        },
                        error: function(data){
                            console.log("Error: ",data);
                        }
                    });
            }
            
            function getLinksInstancia(instancia){
                $.ajax({ 
                        type: 'POST', 
                        url: '/getLinksInstancia', 
                        data: { InstanciaResponsavel: instancia}, 
                        success: function (data) {
                            $(".modalLinks").eq(0).css("display","flex");
                            let lista = "";
                            data.forEach(e=>lista+= "<li>" + e.Url + "</li>")
                            $("#modalLinksBody").html("<ul>" + lista + "</ul>");            
                        },
                        error: function(data){
                            console.log("Error: ",data);
                        }
                    });
            }

            function configuracaoInstancia(Id,ConsoleError,Printscreen,ObterLinks,ObterLinksRepetidos){
                $(".modalConfiguracao").eq(0).css("display","flex");
                $("#ConsoleErrosConfiguracao").prop("checked",ConsoleError);
                $("#PrintscreenConfiguracao").prop("checked",Printscreen);
                $("#ObterLinksConfiguracao").prop("checked",ObterLinks);
                $("#ObterLinksRepetidosConfiguracao").prop("checked",ObterLinksRepetidos);
                $("#urlsInstancia").html("");
                $("#urlsInstancia").append("<option>Selecione</option>")
                instancias.forEach(e=> $("#urlsInstancia").append("<option>"+e.Id+"</option>"));
                
                IdEnviar = Id;
            }

            function enviarConfiguracao(Id,ConsoleError,Printscreen,ObterLinks,ObterLinksRepetidos, instanciaNova){
                $.ajax({ 
                    type: 'POST', 
                    url: '/alterarInstancia', 
                    data: { instancia: Id, ConsoleError:ConsoleError,Printscreen:Printscreen,ObterLinks:ObterLinks,ObterLinksRepetidos:ObterLinksRepetidos, InstanciaNova: instanciaNova}, 
                    success: function (data) {
                        verificaCrawler();
                        $("#btnFecharModalConfiguracao").trigger("click");
                    },
                    error: function(data){
                        console.log("Error: ",data);
                    }
                });
            }

        </script>
    </body>
</html>